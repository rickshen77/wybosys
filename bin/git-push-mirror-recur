#!/usr/bin/env python3

import sys
import os


def isgit(dir) -> bool:
    return os.path.exists(dir + '/HEAD') and \
        os.path.exists(dir + '/config') and \
        os.path.exists(dir + '/hooks') and \
        os.path.exists(dir + '/objects')


def push(dir, cur, target):
    if isgit(dir):
        tgt = target + cur
        old = os.getcwd()
        os.chdir(dir)
        print("正在推送 " + cur + " " + tgt)
        cmds = [
            #'git remote add mirror ' + tgt + '.git',
            #'git push mirror --all',
            #'git push mirror --tags'
            #'git remote rm mirror'
            'git push --mirror ' + tgt + '.git'
        ]
        for cmd in cmds:
            os.system(cmd)
        os.chdir(old)
        # print(cmd)
        return
    if os.path.isdir(dir):
        for each in os.listdir(dir):
            push(dir + "/" + each, cur + "/" + each, target)


if __name__ == "__main__":
    if len(sys.argv) != 2:
        raise Exception("usage: target.domain")
    target = sys.argv[1]
    cwd = os.getcwd()
    push(cwd, '', target)
